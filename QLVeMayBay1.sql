CREATE DATABASE QLVeMayBay
USE QLVeMayBay

SET DATEFORMAT mdy
CREATE TABLE KHACHHANG
(
	MAKH CHAR(5) PRIMARY KEY,
	HOTEN NVARCHAR(50),
	TUOI INT,
	GIOITINH BIT,
	CMND CHAR(15),
	DIACHI NVARCHAR(50),
	SDT CHAR(15),
)
CREATE TABLE HANGHK
(
	MAHHK CHAR(5) PRIMARY KEY,
	TENHHK NVARCHAR(30),
)
CREATE TABLE SANBAY
(
	MASB CHAR(5) PRIMARY KEY,
	TENSANBAY NVARCHAR(40),
)
CREATE TABLE CHUYENBAY
(
	MACB CHAR(5) PRIMARY KEY,
	MASBDI CHAR(5),
	MASBDEN CHAR(5),
	MAHHK CHAR(5),	
	THOIGIANKHOIHANH SMALLDATETIME,
	THOIGIANDEN SMALLDATETIME,
	SOGHEHANG1 INT,
	SOGHEHANG2 INT,
	GIAVE INT
)

CREATE TABLE HANGVE
(
	MAHV CHAR(5) PRIMARY KEY,
	TENHANGVE NVARCHAR(20),
)
CREATE TABLE TINHTRANG
(
	MATT CHAR(5) PRIMARY KEY,
	TENTINHTRANG NVARCHAR(10),
)
CREATE TABLE VE
(
	MAVE CHAR(5) PRIMARY KEY,
	MACB CHAR(5),
	MAHHK CHAR(5),
	MAHV CHAR(5),
	GIATIEN INT,	
	MATT CHAR(5),
)

CREATE TABLE CHITIETCB
(
	MACB CHAR(5) PRIMARY KEY,
	MASBTG CHAR(5),
	THOIGIANDUNG INT,
	GHICHU NVARCHAR(20),
)
CREATE TABLE PHIEUDATMUA
(	
	MAVE CHAR(5),
	MAKH CHAR(5),
	THOIGIANDAT SMALLDATETIME,
	DATHANHTOAN BIT
	PRIMARY KEY (MAVE, MAKH)
)
CREATE TABLE THAMSO
(
	MATS CHAR(5),
	NGAYAPDUNG SMALLDATETIME,
	TENTS NVARCHAR(20),
	GIATRI INT,
)

CREATE PROCEDURE TaoThanhVien
	@MaKH char(5),
	@HoTen NVARCHAR(50),
	@Tuoi INT,
	@GioiTinh BIT,
	@CMND CHAR(15),
	@DiaChi NVARCHAR(50),
	@SDT CHAR(15)
AS
BEGIN
	INSERT INTO KHACHHANG(MaKH, HoTen,Tuoi,GioiTinh,CMND,DiaChi, SDT)
	VALUES (@MaKH, @HoTen,@Tuoi,@GioiTinh,@CMND,@DiaChi, @SDT);
END

CREATE PROCEDURE LietKeCB
AS
BEGIN
	SELECT distinct CB.MACB, A.[SÂN BAY ĐI] AS 'SÂN BAY ĐI', B.[SÂN BAY ĐẾN] AS 'SÂN BAY ĐẾN', 
		HHK.TENHHK AS 'HÃNG HÀNG KHÔNG', THOIGIANKHOIHANH AS'THỜI GIAN KHỞI HÀNH', THOIGIANDEN AS 'THỜI GIAN ĐẾN', 
		CB.SOGHEHANG1 AS 'SỐ GHẾ HẠNG 1', CB.SOGHEHANG2 AS'SỐ GHẾ HẠNG 2', CB.GIAVE AS'GIÁ VÉ'
	FROM 
	(SELECT CB.MASBDI, SB.TENSANBAY AS 'SÂN BAY ĐI' FROM 
			SANBAY SB INNER JOIN CHUYENBAY CB ON CB.MASBDI = SB.MASB) AS A
	INNER JOIN 	CHUYENBAY CB ON A.MASBDI = CB.MASBDI INNER JOIN
	(SELECT CB.MASBDEN, SB.TENSANBAY AS'SÂN BAY ĐẾN' FROM SANBAY SB 
	INNER JOIN CHUYENBAY CB ON CB.MASBDEN = SB.MASB) AS B ON CB.MASBDEN = B.MASBDEN
	INNER JOIN HANGHK HHK ON CB.MAHHK = HHK.MAHHK
END

CREATE PROCEDURE ThemCB
	@MaCB char(5),
	@TenSBDi nvarCHAR(30),
	@TenSBDen nvarCHAR(30),
	@TenHHK nvarCHAR(30),
	@ThoiGianKhoiHanh SMALLDATETIME,
	@ThoiGianDen SMALLDATETIME,
	@SoGheHang1 INT,
	@SoGheHang2 INT,
	@GiaVe INT
AS
BEGIN
	INSERT INTO CHUYENBAY(MACB, MASBDI, MASBDEN, MAHHK, THOIGIANKHOIHANH,THOIGIANDEN, SOGHEHANG1, SOGHEHANG2, GIAVE)
	VALUES (@MaCB,
	(SELECT MASB FROM SANBAY WHERE TENSANBAY = @TenSBDi),
	(SELECT MASB FROM SANBAY WHERE TENSANBAY = @TenSBDen),
	(SELECT MAHHK FROM HANGHK WHERE TENHHK = @TenHHK),
	@ThoiGianKhoiHanh, @ThoiGianDen, @SoGheHang1, @SoGheHang2, @GiaVe)
END

CREATE PROCEDURE SuaCB
	@MaCB char(5),
	@TenSBDi nvarCHAR(30),
	@TenSBDen nvarCHAR(30),
	@TenHHK nvarCHAR(30),
	@ThoiGianKhoiHanh SMALLDATETIME,
	@ThoiGianDen SMALLDATETIME,
	@SoGheHang1 INT,
	@SoGheHang2 INT,
	@GiaVe INT
AS
BEGIN
	UPDATE CHUYENBAY
	SET
	MaSBDi = (SELECT MASB FROM SANBAY WHERE TENSANBAY = @TenSBDi),
	MASBDEN = (SELECT MASB FROM SANBAY WHERE TENSANBAY = @TenSBDen),
	MAHHK = (SELECT MAHHK FROM HANGHK WHERE TENHHK = @TenHHK),
	THOIGIANKHOIHANH = @ThoiGianKhoiHanh,
	THOIGIANDEN = @ThoiGianDen,
	SOGHEHANG1 = @SoGheHang1,
	SOGHEHANG2 = @SoGheHang2,
	GIAVE = @GiaVe
	WHERE MACB = @MaCB;
END

CREATE PROCEDURE XoaCB
	@MaCB char(5)
AS
BEGIN
	DELETE FROM CHUYENBAY WHERE MACB = @MaCB;
END

CREATE PROCEDURE UpdateTinhTrangVe
	@MaTT char(5),
	@MaVe char(5)
AS
BEGIN
	UPDATE VE
	SET MATT = @MaTT
	WHERE MAVE = @MaVe
END

CREATE PROCEDURE TaoPhieuDatMua	
	@MaVe CHAR(5),
	@MaKH CHAR(5),
	@ThoiGianDat SMALLDATETIME
AS
BEGIN
	INSERT INTO PHIEUDATMUA
	VALUES (@MaVe, @MaKH, @ThoiGianDat, 1)
END

CREATE PROCEDURE TraCuu
	@MaSBDi nvarchar(40),
	@MaSBDen nvarchar(40),
	@ThoiGianBay datetime
AS
BEGIN
	SELECT distinct CB.MACB, A.[SÂN BAY ĐI] AS 'SÂN BAY ĐI', B.[SÂN BAY ĐẾN] AS 'SÂN BAY ĐẾN', 
		HHK.TENHHK AS 'HÃNG HÀNG KHÔNG', THOIGIANKHOIHANH AS'THỜI GIAN KHỞI HÀNH', THOIGIANDEN AS 'THỜI GIAN ĐẾN', 
		CB.SOGHEHANG1 AS 'SỐ GHẾ HẠNG 1', CB.SOGHEHANG2 AS'SỐ GHẾ HẠNG 2', CB.GIAVE AS'GIÁ VÉ'
	FROM 
	(SELECT CB.MASBDI, SB.TENSANBAY AS'SÂN BAY ĐI' FROM 
			SANBAY SB INNER JOIN CHUYENBAY CB ON CB.MASBDI = SB.MASB) AS A
	INNER JOIN 	CHUYENBAY CB ON A.MASBDI = CB.MASBDI INNER JOIN
	(SELECT CB.MASBDEN, SB.TENSANBAY AS'SÂN BAY ĐẾN' FROM SANBAY SB 
	INNER JOIN CHUYENBAY CB ON CB.MASBDEN = SB.MASB) AS B ON CB.MASBDEN = B.MASBDEN
	INNER JOIN HANGHK HHK ON CB.MAHHK = HHK.MAHHK
WHERE a.[SÂN BAY ĐI] = @MaSBDi AND b.[SÂN BAY ĐẾN] = @MaSBDen AND 
		convert (date, CB.THOIGIANKHOIHANH) = @ThoiGianBay
END

CREATE PROCEDURE LietKeVe
	@MaCB char(5)
AS
BEGIN
	SELECT DISTINCT VE.MAVE, VE.MACB, HHK.TENHHK AS 'HÃNG HÀNG KHÔNG', HV.TENHANGVE AS 'HẠNG VÉ',
	VE.GIATIEN AS 'GIÁ TIỀN', TT.TENTINHTRANG AS 'TÌNH TRẠNG'
	FROM VE INNER JOIN HANGHK HHK ON VE.MAHHK = HHK.MAHHK
	INNER JOIN TINHTRANG TT ON VE.MATT = TT.MATT
	INNER JOIN HANGVE HV ON HV.MAHV = VE.MAHV
	WHERE VE.MACB = @MaCB
END

CREATE PROCEDURE ChonHangVe
	@TenHangVe nvarchar(8),
	@MaCB char(5)
AS
BEGIN
	SELECT DISTINCT VE.MAVE, VE.MACB,HHK.TENHHK AS 'HÃNG HÀNG KHÔNG', HV.TENHANGVE AS 'HẠNG VÉ',
	VE.GIATIEN AS 'GIÁ TIỀN', TT.TENTINHTRANG AS 'TÌNH TRẠNG'
	FROM VE INNER JOIN HANGHK HHK ON VE.MAHHK = HHK.MAHHK
	INNER JOIN TINHTRANG TT ON VE.MATT = TT.MATT
	INNER JOIN HANGVE HV ON HV.MAHV = VE.MAHV
	WHERE HV.TENHANGVE = @TenHangVe and VE.MACB = @MaCB
END

CREATE PROCEDURE LoadSanBay
	@MaSB char(5)
AS
BEGIN
	SELECT TENSANBAY
	FROM SANBAY 
	WHERE MASB = @MaSB
END

CREATE PROCEDURE BaoCao
	@TuNgay smalldatetime,
	@DenNgay smalldatetime
AS
BEGIN
	SELECT DISTINCT A.MACB,A.[ĐÃ BÁN], A.[DOANH THU], ROUND(A.[ĐÃ BÁN]*1.0/B.[TỔNG SỐ],2) AS'TỈ LỆ'
	FROM 
		(SELECT VE.MACB, COUNT(VE.MAVE) AS'ĐÃ BÁN', SUM(VE.GIATIEN) AS 'DOANH THU'
			FROM VE 
			INNER JOIN PHIEUDATMUA PDM ON VE.MAVE = PDM.MAVE
			WHERE VE.MATT='TT001'
			GROUP BY VE.MACB) AS A 
		INNER JOIN 
			(SELECT VE.MACB, COUNT(VE.MAVE) AS 'TỔNG SỐ'
			FROM VE
			GROUP BY VE.MACB) AS B
		ON A.MACB = B.MACB
		INNER JOIN VE ON A.MACB = VE.MACB
		INNER JOIN PHIEUDATMUA PDM ON VE.MAVE=PDM.MAVE
	WHERE VE.MATT='TT001' AND CONVERT(DATE, PDM.THOIGIANDAT) >= @TuNgay 
		AND CONVERT(DATE, PDM.THOIGIANDAT) <= @DenNgay
END

CREATE PROCEDURE BaoCaoNam
	@NAM INT
AS
BEGIN
	SELECT DISTINCT A.MACB,A.[ĐÃ BÁN], A.[DOANH THU], ROUND(A.[ĐÃ BÁN]*1.0/B.[TỔNG SỐ],2) AS'TỈ LỆ'
	FROM 
		(SELECT VE.MACB, COUNT(VE.MAVE) AS'ĐÃ BÁN', SUM(VE.GIATIEN) AS 'DOANH THU'
			FROM VE 
			INNER JOIN PHIEUDATMUA PDM ON VE.MAVE = PDM.MAVE
			WHERE VE.MATT='TT001'
			GROUP BY VE.MACB) AS A 
		INNER JOIN 
			(SELECT VE.MACB, COUNT(VE.MAVE) AS 'TỔNG SỐ'
			FROM VE
			GROUP BY VE.MACB) AS B
		ON A.MACB = B.MACB
		INNER JOIN VE ON A.MACB = VE.MACB
		INNER JOIN PHIEUDATMUA PDM ON VE.MAVE=PDM.MAVE
	WHERE VE.MATT='TT001' AND DATEPART(YEAR, PDM.THOIGIANDAT) = @NAM
END


insert into TINHTRANG values('TT000','CÒN TRỐNG');
insert into TINHTRANG values('TT001','ĐÃ BÁN');
insert into TINHTRANG values('TT002','ĐÃ ĐẶT');

insert into HANGVE values('HV001','Vé Hạng 1')
insert into HANGVE values('HV002','Vé Hạng 2')

insert into  SANBAY values('SB001','Sân bay quốc tế Đà Nẵng')
insert into  SANBAY values('SB002','Sân bay quốc tế Nội Bài')
insert into  SANBAY values('SB003','Sân bay quốc tế Tân Sơn Nhất')
insert into  SANBAY values('SB004','Sân bay quốc tế Phú Quốc')
insert into  SANBAY values('SB005','Sân bay quốc tế Vinh')
insert into  SANBAY values('SB006','Sân bay Chu Lai')
insert into  SANBAY values('SB007','Sân bay Tuy Hòa')
insert into  SANBAY values('SB008','Sân bay Đồng Hới')
insert into  SANBAY values('SB009','Sân bay Điện Biên Phủ')
insert into  SANBAY values('SB010','Sân bay Cà Mau')

insert into HANGHK values('HHK01','Vietnam Airlines')
insert into HANGHK values('HHK02','VietJetAir')
insert into HANGHK values('HHK03','VASCO')
insert into HANGHK values('HHK04','Jetstar Pacific Airlines')

insert into CHUYENBAY values ('CB001','SB001','SB009','HHK01','5/15/2018','5/15/2018','50','50',1000000)
insert into CHUYENBAY values ('CB002','SB002','SB010','HHK03','5/16/2018','5/16/2018','60','60',2000000)
insert into CHUYENBAY values ('CB003','SB003','SB007','HHK04','12/5/2018','12/5/2018','40','40',1500000)

insert into VE values('VE101','CB001','HHK01','HV001',1005000,'TT001');
insert into VE values('VE102','CB001','HHK01','HV002',1000000,'TT002');
insert into VE values('VE103','CB001','HHK01','HV001',1050000,'TT000');
insert into VE values('VE201','CB002','HHK03','HV001',2100000,'TT000');
insert into VE values('VE202','CB002','HHK03','HV001',2100000,'TT001');
insert into VE values('VE203','CB002','HHK03','HV002',2000000,'TT002');
insert into VE values('VE301','CB003','HHK04','HV002',1500000,'TT001');
insert into VE values('VE302','CB003','HHK04','HV001',1575000,'TT002');

CREATE PROCEDURE LoadVe
	@MaCB char(5) =null,
	@MaVe char(5) =null
AS
BEGIN
	SELECT VE.MAVE, VE.MACB, VE.GIATIEN AS 'GIÁ VÉ', TT.TENTINHTRANG AS 'TÌNH TRẠNG', PDM.DATHANHTOAN AS'THANH TOÁN'
	FROM VE INNER JOIN TINHTRANG TT ON VE.MATT = TT.MATT
	INNER JOIN PHIEUDATMUA PDM ON VE.MAVE = PDM.MAVE
	WHERE VE.MACB = @MaCB OR VE.MAVE = @MaVe
END

